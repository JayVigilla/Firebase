<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider System Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 0 0 10px #00ff00;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #004400;
            border-radius: 4px;
            background: #0f0f0f;
        }

        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ffff;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #004400;
            background: #050505;
        }

        .success {
            border-left-color: #00ff00;
            color: #00ff00;
        }

        .error {
            border-left-color: #ff0000;
            color: #ff0000;
        }

        .warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }

        .info {
            border-left-color: #00aaff;
            color: #00aaff;
        }

        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        button:hover {
            background: #00cc00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        .btn-group {
            text-align: center;
            margin: 20px 0;
        }

        .code-block {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #00ff00;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #00ff00;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #0f0f0f;
            padding: 15px;
            border: 1px solid #004400;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #888;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß RIDER SYSTEM DIAGNOSTICS</h1>
        
        <div class="btn-group">
            <button onclick="runAllTests()">‚ñ∂ Run All Tests</button>
            <button onclick="testFirebase()">üî• Test Firebase</button>
            <button onclick="testRiderAuth()">üë§ Test Rider Auth</button>
            <button onclick="testOrders()">üì¶ Test Orders</button>
            <button onclick="clearData()">üóëÔ∏è Clear Local Data</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"

        const firebaseConfig = {
            apiKey: "AIzaSyAGbKxcni6TjGEnYjMPYOkJfdqXq57MeHs",
            authDomain: "florist-3da75.firebaseapp.com",
            projectId: "florist-3da75",
            storageBucket: "florist-3da75.firebasestorage.app",
            messagingSenderId: "424840107599",
            appId: "1:424840107599:web:5070aca3d345318c0fbc3a"
        }

        let db
        let app
        const results = document.getElementById('results')

        function log(message, type = 'info') {
            const div = document.createElement('div')
            div.className = `test-result ${type}`
            div.innerHTML = message
            results.appendChild(div)
            console.log(message)
        }

        function section(title) {
            const div = document.createElement('div')
            div.className = 'test-section'
            div.innerHTML = `<div class="test-title">${title}</div>`
            results.appendChild(div)
            return div
        }

        function clearResults() {
            results.innerHTML = ''
        }

        window.runAllTests = async function() {
            clearResults()
            log('üöÄ Starting comprehensive diagnostic tests...', 'info')
            
            await testFirebase()
            await testRiderAuth()
            await testOrders()
            await testRiders()
            await testNetwork()
            
            log('‚úÖ All tests completed!', 'success')
        }

        window.testFirebase = async function() {
            const sec = section('üî• FIREBASE CONNECTION TEST')
            
            try {
                log('Initializing Firebase...', 'info')
                app = initializeApp(firebaseConfig)
                db = getFirestore(app)
                log('‚úÖ Firebase initialized successfully', 'success')
                
                log('Testing Firestore connection...', 'info')
                const testDoc = await getDocs(collection(db, "riders"))
                log(`‚úÖ Firestore connected! Found ${testDoc.size} riders`, 'success')
                
                return true
            } catch (error) {
                log(`‚ùå Firebase Error: ${error.message}`, 'error')
                log(`Error Code: ${error.code}`, 'error')
                return false
            }
        }

        window.testRiderAuth = async function() {
            const sec = section('üë§ RIDER AUTHENTICATION TEST')
            
            const riderId = localStorage.getItem('currentRiderId')
            
            if (!riderId) {
                log('‚ùå No rider ID found in localStorage', 'error')
                log('üí° Solution: Login via rider-login.html first', 'warning')
                return false
            }
            
            log(`‚úÖ Rider ID found: ${riderId}`, 'success')
            
            try {
                log('Fetching rider information from Firestore...', 'info')
                const riderDoc = await getDoc(doc(db, "riders", riderId))
                
                if (!riderDoc.exists()) {
                    log('‚ùå Rider document not found in Firestore', 'error')
                    log(`üí° Rider ID ${riderId} does not exist in database`, 'warning')
                    return false
                }
                
                const rider = riderDoc.data()
                log('‚úÖ Rider document loaded successfully', 'success')
                log(`<div class="code-block">
                    <strong>Rider Details:</strong><br>
                    Name: ${rider.name}<br>
                    Phone: ${rider.phone}<br>
                    Vehicle: ${rider.vehicle}<br>
                    Status: ${rider.status || (rider.isOnline ? 'online' : 'offline')}<br>
                    Last Active: ${rider.lastActive ? new Date(rider.lastActive.toDate()).toLocaleString() : 'N/A'}
                </div>`, 'info')
                
                return true
            } catch (error) {
                log(`‚ùå Error loading rider: ${error.message}`, 'error')
                if (error.code === 'permission-denied') {
                    log('‚ö†Ô∏è Permission denied - Check Firestore security rules', 'warning')
                }
                return false
            }
        }

        window.testOrders = async function() {
            const sec = section('üì¶ ORDERS TEST')
            
            const riderId = localStorage.getItem('currentRiderId')
            
            if (!riderId) {
                log('‚ùå No rider ID - cannot test orders', 'error')
                return false
            }
            
            try {
                log('Querying orders assigned to this rider...', 'info')
                
                const ordersRef = collection(db, "orders")
                const q = query(ordersRef, where("riderId", "==", riderId))
                const querySnapshot = await getDocs(q)
                
                log(`‚úÖ Found ${querySnapshot.size} orders`, 'success')
                
                if (querySnapshot.size === 0) {
                    log('‚ö†Ô∏è No orders assigned to this rider', 'warning')
                    log('üí° Admin needs to assign orders first', 'info')
                    return true
                }
                
                const orders = []
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() })
                })
                
                // Group by status
                const byStatus = {
                    assigned: orders.filter(o => o.status === 'assigned'),
                    picked_up: orders.filter(o => o.status === 'picked_up'),
                    in_transit: orders.filter(o => o.status === 'in_transit'),
                    delivered: orders.filter(o => o.status === 'delivered')
                }
                
                log(`<div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Pending</div>
                        <div class="stat-value">${byStatus.assigned.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Picked Up</div>
                        <div class="stat-value">${byStatus.picked_up.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">In Transit</div>
                        <div class="stat-value">${byStatus.in_transit.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Delivered</div>
                        <div class="stat-value">${byStatus.delivered.length}</div>
                    </div>
                </div>`, 'info')
                
                // Show details of each order
                orders.forEach(order => {
                    const createdAt = order.createdAt?.toDate?.() || new Date(order.createdAt)
                    log(`<div class="code-block">
                        <strong>Order #${order.id.substring(0, 8)}</strong><br>
                        Status: ${order.status}<br>
                        Customer: ${order.fullName}<br>
                        Total: ‚Ç±${order.total}<br>
                        Created: ${createdAt.toLocaleString()}<br>
                        Items: ${order.items?.length || 0}
                    </div>`, 'info')
                })
                
                return true
            } catch (error) {
                log(`‚ùå Error fetching orders: ${error.message}`, 'error')
                if (error.code === 'permission-denied') {
                    log('‚ö†Ô∏è Permission denied - Check Firestore security rules', 'warning')
                }
                return false
            }
        }

        window.testRiders = async function() {
            const sec = section('üõµ ALL RIDERS TEST')
            
            try {
                log('Fetching all riders from database...', 'info')
                const ridersSnapshot = await getDocs(collection(db, "riders"))
                
                log(`‚úÖ Found ${ridersSnapshot.size} riders in database`, 'success')
                
                ridersSnapshot.forEach((doc) => {
                    const rider = doc.data()
                    const status = rider.status || (rider.isOnline ? 'online' : 'offline')
                    log(`<div class="code-block">
                        <strong>${rider.name}</strong> [${doc.id.substring(0, 8)}]<br>
                        Status: <span class="${status === 'online' ? 'success' : 'warning'}">${status}</span><br>
                        Vehicle: ${rider.vehicle}<br>
                        Phone: ${rider.phone}
                    </div>`, 'info')
                })
                
                return true
            } catch (error) {
                log(`‚ùå Error fetching riders: ${error.message}`, 'error')
                return false
            }
        }

        window.testNetwork = function() {
            const sec = section('üåê NETWORK TEST')
            
            log(`Online Status: ${navigator.onLine ? '‚úÖ ONLINE' : '‚ùå OFFLINE'}`, 
                navigator.onLine ? 'success' : 'error')
            
            log(`User Agent: ${navigator.userAgent}`, 'info')
            log(`Platform: ${navigator.platform}`, 'info')
            
            if ('geolocation' in navigator) {
                log('‚úÖ Geolocation API available', 'success')
            } else {
                log('‚ùå Geolocation API not available', 'error')
            }
            
            if ('localStorage' in window) {
                log('‚úÖ localStorage available', 'success')
                const items = Object.keys(localStorage)
                log(`localStorage items: ${items.join(', ')}`, 'info')
            } else {
                log('‚ùå localStorage not available', 'error')
            }
        }

        window.clearData = function() {
            if (confirm('Clear all local data? This will log you out.')) {
                localStorage.clear()
                log('‚úÖ All local data cleared', 'success')
                log('üîÑ Refresh page or login again', 'warning')
            }
        }

        // Initialize on load
        log('üîß Diagnostic tool loaded. Click "Run All Tests" to begin.', 'info')
    </script>
</body>
</html>